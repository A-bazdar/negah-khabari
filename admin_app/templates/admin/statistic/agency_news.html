{% extends '../admin_base.html' %}

{% block other_css %}
<link rel="stylesheet" href="{{ static_url('plugins/DatePicker/pwt-datepicker.css') }}">
<style>
    .amcharts-chart-div a{
        display: none !important;
    }

    .highcharts-title, .highcharts-button, .highcharts-yaxis-title{
        display: none !important;
    }

    svg > text{
        display: none !important;
    }

    text{
        font-family: Yekan !important;
    }
</style>
{% end block other_css %}

{% block container %}
    <div id="page-wrapper">
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default margin-top-30 font-yekan">
                    <div class="panel-heading"><i class="fa fa-folder-open-o"></i><span>گزارشات آماری</span> </div>
                    <div class="panel-body">
                        <div class="show_box" data-action="1">
                            <div class="box_header">
                                <span>آمار خبر های خوانده شده</span>
                            </div>
                            <div class="box_body">
                                <div class="row">
                                    <div class="col-md-5 col-sm-5">
                                        <div class="row">
                                            <div class="col-md-4">خبرگذاری : </div>
                                            <div class="col-md-8">
                                                <select class="select" name="change-agency" style="width: 100%">
                                                    <option value="all">همه خبرگذاری ها</option>
                                                    {% for a in agencies %}
                                                        <option {% if str(a['id']) == str(this_agency) %}selected{% end %} value="{{ a['id'] }}">{{ a['name'] }}</option>
                                                    {% end %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-7 col-sm-7">
                                        <div class="row">
                                            <div class="col-md-2">بازه زمانی : </div>
                                            <div class="col-md-10">
                                                <div class="row">
                                                    <div class="col-md-4 col-sm-4">
                                                        <input type="checkbox" name="given-interval" value="true" class="given_interval_checkbox"> بازه دلخواه
                                                    </div>
                                                    <div class="no_given_interval">
                                                        <div class="col-md-4 col-sm-4">
                                                            <input type="text" value="{{ time_value }}" name="time-value" class="form-control">
                                                        </div>
                                                        <div class="col-md-4 col-sm-4">
                                                            <select class="select" name="time-type">
                                                                <option {% if time_type == 'hours' %}selected{% end %} value="hours">ساعت</option>
                                                                <option {% if time_type == 'days' %}selected{% end %} value="days">روز</option>
                                                                <option {% if time_type == 'weeks' %}selected{% end %} value="weeks">هفته</option>
                                                                <option {% if time_type == 'months' %}selected{% end %} value="months">ماه</option>
                                                                <option {% if time_type == 'years' %}selected{% end %} value="years">سال</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="given_interval" style="display: none">
                                                        <div class="col-md-8 col-sm-8">
                                                            <div class="row">
                                                                <div class="col-md-5 col-sm-5">
                                                                    <input type="text" name="start-date" class="datePicker form-control">
                                                                </div>
                                                                <div class="col-md-2 col-sm-2">
                                                                    تا
                                                                </div>
                                                                <div class="col-md-5 col-sm-5">
                                                                    <input type="text" name="end-date" class="datePicker form-control">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-2 col-md-offset-5 col-sm-2 col-sm-offset-5 text-center margin-top-30">
                                        <div style="width: 100%" class="btn R_butt_green new-statistic">جستجو</div>
                                    </div>
                                </div>
                                <hr>
                                <div class="row margin-top-25">
                                    <div class="col-md-12 col-sm-12">
                                        <div id="chartdiv" style="direction: ltr ;height: 400px; width: 100%; font-size: 15pt; font-family: Yekan !important;"></div>
                                    </div>
                                </div>
                                <div class="row margin-top-15">
                                    <div class="col-md-12 col-sm-12">
                                        <div id="container" style="direction: ltr ;min-width: 310px; height: 400px; margin: 0 auto"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<input type="hidden" name="dataProvider" value="{{ dataProvider }}">
<input type="hidden" name="data" value="{{ data }}">
<input type="hidden" name="categories" value="{{ categories }}">
{% end block container %}

{% block other_scripts %}
<script src="{{ static_url('plugins/Highchart/highcharts.js')}}"></script>
<script src="{{ static_url('plugins/Highchart/exporting.js')}}"></script>
<script src="{{ static_url('plugins/amchart/amcharts.js')}}"></script>
<script src="{{ static_url('plugins/amchart/pie.js')}}"></script>
<script src="{{ static_url('plugins/amchart/light.js')}}"></script>
<script src="{{ static_url('plugins/DatePicker/pwt-date.js') }}"></script>
<script src="{{ static_url('plugins/DatePicker/pwt-datepicker.js') }}"></script>

<script>
$(".datePicker").val("").pDatepicker();
var chart = AmCharts.makeChart( "chartdiv", {
    "type": "pie",
    "theme": "light",
    "dataProvider": jQuery.parseJSON($('input[name=dataProvider]').val()),
    "titleField": "title",
    "valueField": "value",
    "labelRadius": 8,

    "radius": "42%",
    "innerRadius": "60%",
    "labelText": "[[title]]",
    "export": {
        "enabled": true
    }
});
$(function () {
    $('#container').highcharts({
        chart: {
            type: 'column'
        },
        xAxis: {
            categories: jQuery.parseJSON($('input[name=categories]').val()),
            crosshair: true
        },
        tooltip: {
            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                '<td style="padding:0"><b>{point.y:.1f}</b></td></tr>',
            footerFormat: '</table>',
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0
            }
        },
        series: [{
            name: 'آمار خبر های خوانده شده',
            data: jQuery.parseJSON($('input[name=data]').val())

        }]
    });
});
$('.given_interval_checkbox').change(function(){
    if(this.checked){
        $('.given_interval').css('display', 'block');
        $('.no_given_interval').css('display', 'none');
    }else{
        $('.given_interval').css('display', 'none');
        $('.no_given_interval').css('display', 'block');
    }
});

var __a = true;
$(document).on('click', '.new-statistic', function(e){
    var btn = $(e.target);
    btn.html('<img src="{{ static_url('images/loading.gif') }}" height="20" width="20">');
    var change_agency = $('select[name=change-agency]').select2("val");
    var given_interval = $('input[name=given-interval]:checked').val();
    var time_value = $('input[name=time-value]').val();
    var time_type = $('select[name=time-type]').select2("val");
    var start_date = $('input[name=start-date]').val();
    var end_date = $('input[name=end-date]').val();
    if(given_interval == 'true'){
        given_interval = 1
    }else{
        given_interval = 0
    }
    var postData = [
        {name: 'change_agency', value: change_agency},
        {name: 'given_interval', value: given_interval},
        {name: 'time_value', value: time_value},
        {name: 'time_type', value: time_type},
        {name: 'start_date', value: start_date},
        {name: 'end_date', value: end_date},
        {name: '_xsrf', value: '{{ handler.xsrf_token }}'}
    ];
    jQuery.ajax(
        {
            url: '',
            type: "post",
            data: postData,
            success: function (response) {
                var status = response['status'];
                var value = response['value'];
                var messages = response['messages'];
                if (status) {
                    AmCharts.makeChart( "chartdiv", {
                        "type": "pie",
                        "theme": "light",
                        "dataProvider": value['dataProvider'],
                        "titleField": "title",
                        "valueField": "value",
                        "labelRadius": 8,

                        "radius": "42%",
                        "innerRadius": "60%",
                        "labelText": "[[title]]",
                        "export": {
                            "enabled": true
                        }
                    });
                    $(function () {
                        $('#container').highcharts({
                            chart: {
                                type: 'column'
                            },
                            xAxis: {
                                categories: value['categories'],
                                crosshair: true
                            },
                            tooltip: {
                                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                                pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                                    '<td style="padding:0"><b>{point.y:.1f}</b></td></tr>',
                                footerFormat: '</table>',
                                shared: true,
                                useHTML: true
                            },
                            plotOptions: {
                                column: {
                                    pointPadding: 0.2,
                                    borderWidth: 0
                                }
                            },
                            series: [{
                                name: 'آمار خبر های خوانده شده',
                                data: value['data']

                            }]
                        });
                    });
                    btn.html('جستجو');
                    __a = true;
                }
            },
            error: function () {
                Alert.render('error', function(){
                    btn.html('جستجو');
                    __a = true;
                });
            }
        });
});

</script>

{% end block other_scripts %}